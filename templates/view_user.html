<!doctype html>
<html lang='ru'>
<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>Профиль пользователя</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin: 20px; line-height: 1.4; }
    .card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; max-width: 900px; }
    .row { display:flex; gap: 20px; }
    .col { flex: 1; }
    h2 { margin-top: 0; }
    dt { font-weight: 600; }
    dd { margin: 0 0 8px 0; }
    .muted { color:#64748b; }
    .actions { margin: 12px 0; }
    button, a.btn { background: #2563eb; color: white; border: 0; padding: 10px 14px; border-radius: 8px; cursor: pointer; text-decoration:none; }
    a.btn.secondary { background: #334155; }
    .msg { margin: 12px 0; padding: 10px 12px; border-radius: 8px; background: #ecfeff; border: 1px solid #38bdf8; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #e2e8f0; padding: 6px; text-align: left; vertical-align: top; }
    details summary { cursor: pointer; color: #2563eb; margin-bottom: 6px; }
    form.stacked-form { display: flex; flex-direction: column; gap: 6px; }
    form.stacked-form textarea { width: 100%; min-height: 70px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; }
    form.stacked-form button { align-self: flex-start; }
  </style>
</head>
<body>
  <h2>Профиль пользователя #{{ user.id }}</h2>
  {% if msg %}<div class='msg'>{{ msg }}</div>{% endif %}
  <div class='actions'>
    <a class='btn' href='/edit-user/{{ user.id }}'>Изменить параметры</a>
    <a class='btn secondary' href='/?kind={{ 'supervisors' if user.role=='supervisor' else 'students' }}'>Назад к списку</a>
    {% if user.role=='student' %}
      <form method='post' action='/do-match-student' style='display:inline; margin-left:8px;'>
        <input type='hidden' name='student_user_id' value='{{ user.id }}' />
        <button type='submit'>Подобрать темы</button>
      </form>
    {% elif user.role=='supervisor' %}
      <form method='post' action='/do-match-supervisor' style='display:inline; margin-left:8px;'>
        <input type='hidden' name='supervisor_user_id' value='{{ user.id }}' />
        <button type='submit'>Подобрать темы</button>
      </form>
    {% endif %}
  </div>
  <div class='card'>
    <div class='row'>
      <div class='col'>
        <h3>Основное</h3>
        <dl>
          <dt>ФИО</dt><dd>{{ user.full_name }}</dd>
          <dt>Email</dt><dd>{{ user.email or '-' }}</dd>
          <dt>Username (tg)</dt>
          <dd>
            {% if user.username %}
              {% set u = user.username %}
              {% if 't.me' in u %}
                <a href="{{ u }}" target="_blank">{{ u }}</a>
              {% else %}
                {% set uname = u.lstrip('@') %}
                <a href="https://t.me/{{ uname }}" target="_blank">@{{ uname }}</a>
              {% endif %}
            {% else %}-{% endif %}
          </dd>
          <dt>Роль</dt><dd>{{ user.role }}</dd>
          <dt>Создан</dt><dd>{{ user.created_at }}</dd>
        </dl>
      </div>
      <div class='col'>
        {% if student %}
          <h3>Профиль студента</h3>
          <dl>
            <dt>Направление</dt><dd>{{ student.program or '-' }}</dd>
            <dt>Навыки</dt><dd>{{ student.skills or '-' }}</dd>
            <dt>Интересы</dt><dd>{{ student.interests or '-' }}</dd>
            <dt>CV</dt>
            <dd>
              {% if student.cv %}
                {% if student.cv.startswith('/media/') %}
                  <a href="{{ student.cv }}" target="_blank">Скачать CV</a>
                {% else %}
                  <a href="{{ student.cv }}" target="_blank">{{ student.cv }}</a>
                {% endif %}
              {% else %}-{% endif %}
            </dd>
            <dt>Треки</dt><dd>dev: {{ student.dev_track }}, science: {{ student.science_track }}, startup: {{ student.startup_track }}</dd>
          </dl>
        {% elif supervisor %}
          <h3>Профиль руководителя</h3>
          <dl>
            <dt>Должность</dt><dd>{{ supervisor.position or '-' }}</dd>
            <dt>Степень</dt><dd>{{ supervisor.degree or '-' }}</dd>
            <dt>Лимит</dt><dd>{{ supervisor.capacity or '-' }}</dd>
            <dt>Интересы</dt><dd>{{ supervisor.interests or '-' }}</dd>
            <dt>Требования</dt><dd>{{ supervisor.requirements or '-' }}</dd>
          </dl>
        {% else %}
          <p class='muted'>Профиль отсутствует.</p>
        {% endif %}
      </div>
    </div>
  </div>

  {% if user.role == 'student' %}
    <div class='card' id='recommended-roles' style='margin-top:12px;'>
      <h3>Рекомендованные роли</h3>
      {% if recommended_roles %}
        <table>
          <tr><th>Место</th><th>Роль</th><th>Оценка</th><th>Действия</th></tr>
          {% for r in recommended_roles %}
            <tr>
              <td>{{ r.rank or '-' }}</td>
              <td>
                <strong><a href='/role/{{ r.role_id }}'>{{ r.role_name or ('Роль #' ~ r.role_id) }}</a></strong>
                <div class='muted'>Тема: <a href='/topic/{{ r.topic_id }}'>{{ r.topic_title or ('Тема #' ~ r.topic_id) }}</a></div>
                <div class='muted'>Автор: {{ r.author_name or '-' }}</div>
              </td>
              <td>{{ '%.2f'|format(r.score) if r.score is not none else '-' }}</td>
              <td>
                {% if r.author_user_id %}
                  <details>
                    <summary>Подать заявку</summary>
                    <form method='post' action='/send-request' class='stacked-form'>
                      <input type='hidden' name='sender_user_id' value='{{ user.id }}' />
                      <input type='hidden' name='receiver_user_id' value='{{ r.author_user_id }}' />
                      <input type='hidden' name='topic_id' value='{{ r.topic_id }}' />
                      <input type='hidden' name='role_id' value='{{ r.role_id }}' />
                      <input type='hidden' name='return_url' value='{{ request.url.path }}#recommended-roles' />
                      <label>Сообщение<textarea name='body' required>{{ r.default_message }}</textarea></label>
                      <button type='submit'>Отправить заявку</button>
                    </form>
                  </details>
                {% else %}
                  <span class='muted'>Нет автора для заявки</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      {% else %}
        <p class='muted'>Пока нет сохранённых рекомендаций. Нажмите «Подобрать темы», чтобы обновить список.</p>
      {% endif %}
    </div>
  {% endif %}

  {% if user.role == 'supervisor' %}
    <div class='card' id='recommended-topics' style='margin-top:12px;'>
      <h3>Рекомендованные темы</h3>
      {% if recommended_topics %}
        <table>
          <tr><th>Место</th><th>Тема</th><th>Оценка</th><th>Действия</th></tr>
          {% for t in recommended_topics %}
            <tr>
              <td>{{ t.rank or '-' }}</td>
              <td>
                <strong><a href='/topic/{{ t.topic_id }}'>{{ t.title or ('Тема #' ~ t.topic_id) }}</a></strong>
                <div class='muted'>Автор: {{ t.author_name or '-' }}</div>
                {% if t.direction %}<div class='muted'>Направление: {{ t.direction }}</div>{% endif %}
              </td>
              <td>{{ '%.2f'|format(t.score) if t.score is not none else '-' }}</td>
              <td>
                {% if t.author_user_id %}
                  <details>
                    <summary>Предложить участие</summary>
                    <form method='post' action='/send-request' class='stacked-form'>
                      <input type='hidden' name='sender_user_id' value='{{ user.id }}' />
                      <input type='hidden' name='receiver_user_id' value='{{ t.author_user_id }}' />
                      <input type='hidden' name='topic_id' value='{{ t.topic_id }}' />
                      <input type='hidden' name='return_url' value='{{ request.url.path }}#recommended-topics' />
                      <label>Сообщение<textarea name='body' required>{{ t.default_message }}</textarea></label>
                      <button type='submit'>Отправить заявку</button>
                    </form>
                  </details>
                {% else %}
                  <span class='muted'>Нет автора для заявки</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      {% else %}
        <p class='muted'>Пока нет сохранённых рекомендаций. Нажмите «Подобрать темы», чтобы обновить список.</p>
      {% endif %}
    </div>
  {% endif %}
</body>
</html>
