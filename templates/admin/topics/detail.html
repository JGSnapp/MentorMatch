{% extends 'admin/base.html' %}
{% block title %}Тема #{{ topic.id }} — MentorMatch{% endblock %}
{% block page_title %}{{ topic.title or ('Тема #' ~ topic.id) }}{% endblock %}
{% block page_description %}Подробности темы, роли и кандидаты{% endblock %}
{% block header_actions %}
  <a class="btn" href="/edit-topic/{{ topic.id }}">Редактировать</a>
  <a class="btn btn--ghost" href="/?kind=topics">К списку</a>
  <form class="form-inline" method="post" action="/do-match-topic">
    <input type="hidden" name="topic_id" value="{{ topic.id }}" />
    <input type="hidden" name="target_role" value="{{ topic.seeking_role or 'student' }}" />
    <button class="btn btn--secondary" type="submit">Подобрать {{ 'студентов' if (topic.seeking_role or 'student')=='student' else 'руководителей' }}</button>
  </form>
{% endblock %}

{% block content %}
<section class="section">
  <article class="card">
    <h2 class="card__title">Основное</h2>
    <div class="properties">
      <div class="properties__item"><span class="properties__label">ID</span><div class="properties__value">#{{ topic.id }}</div></div>
      <div class="properties__item"><span class="properties__label">Автор</span><div class="properties__value">{{ topic.author }}</div></div>
      <div class="properties__item"><span class="properties__label">Кого ищем</span><div class="properties__value"><span class="pill">{{ topic.seeking_role }}</span></div></div>
      <div class="properties__item"><span class="properties__label">Направление</span><div class="properties__value">{{ topic.direction or '-' }}</div></div>
      <div class="properties__item"><span class="properties__label">Активность</span><div class="properties__value">{{ 'Да' if topic.is_active else 'Нет' }}</div></div>
      <div class="properties__item"><span class="properties__label">Создана</span><div class="properties__value">{{ topic.created_at }}</div></div>
      <div class="properties__item">
        <span class="properties__label">Утверждённый руководитель</span>
        <div class="properties__value">
          {% if topic.approved_supervisor_user_id %}
            <a href="/user/{{ topic.approved_supervisor_user_id }}">#{{ topic.approved_supervisor_user_id }}</a>
            <form class="form-inline" method="post" action="/api/topics/{{ topic.id }}/clear-approved-supervisor">
              <input type="hidden" name="by_user_id" value="{{ topic.author_user_id }}" />
              <button class="btn btn--ghost" type="submit">Снять утверждение</button>
            </form>
          {% else %}-{% endif %}
        </div>
      </div>
    </div>
  </article>

  <article class="card">
    <h2 class="card__title">Описание</h2>
    <div class="properties">
      <div class="properties__item" style="grid-column: 1 / -1;">
        <span class="properties__label">Ключевые навыки</span>
        <div class="properties__value">{{ topic.required_skills or '-' }}</div>
      </div>
      <div class="properties__item" style="grid-column: 1 / -1;">
        <span class="properties__label">Ожидаемые результаты</span>
        <div class="properties__value">{{ topic.expected_outcomes or '-' }}</div>
      </div>
      <div class="properties__item" style="grid-column: 1 / -1;">
        <span class="properties__label">Полное описание</span>
        <div class="properties__value"><pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">{{ topic.description or '-' }}</pre></div>
      </div>
    </div>
  </article>

  <article class="card">
    <h2 class="card__title">Роли</h2>
    {% if roles %}
      <ul class="list">
        {% for r in roles %}
          <li class="list__item">
            <div>
              <strong><a href="/role/{{ r.id }}">{{ r.name or ('Роль #' ~ r.id) }}</a></strong>
              <span class="chip">Вместимость: {{ r.capacity or '-' }}</span>
            </div>
            <div class="list__meta">
              <form class="form-inline" method="post" action="/do-match-role">
                <input type="hidden" name="role_id" value="{{ r.id }}" />
                <button class="btn btn--ghost" type="submit">Подобрать студентов</button>
              </form>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Ролей пока нет.</p>
    {% endif %}

    <h3 class="card__title" style="margin-top:24px; font-size:1.05rem;">Добавить роль</h3>
    <form method="post" action="/add-role">
      <input type="hidden" name="topic_id" value="{{ topic.id }}" />
      <div class="form-field"><label for="role_name">Название роли</label><input class="form-control" id="role_name" type="text" name="name" required></div>
      <div class="form-field"><label for="role_description">Описание</label><textarea class="form-control" id="role_description" name="description" placeholder="опционально"></textarea></div>
      <div class="form-field"><label for="role_skills">Требуемые навыки</label><input class="form-control" id="role_skills" type="text" name="required_skills" placeholder="через запятую"></div>
      <div class="form-field"><label for="role_capacity">Вместимость</label><input class="form-control" id="role_capacity" type="number" name="capacity" min="0" placeholder="опционально"></div>
      <div class="form-actions"><button class="btn" type="submit">Добавить</button></div>
    </form>
  </article>

  <article class="card" id="supervisor-candidates">
    <h2 class="card__title">Кандидаты в руководители</h2>
    <p class="card__subtitle">Лучшие совпадения алгоритма (до 10 записей).</p>
    {% if supervisor_candidates %}
      <table class="table">
        <thead><tr><th>Место</th><th>Руководитель</th><th>Оценка</th><th>Действия</th></tr></thead>
        <tbody>
          {% for s in supervisor_candidates %}
            <tr>
              <td>{{ s.rank or '-' }}</td>
              <td>
                <strong><a href="/supervisor/{{ s.user_id }}">{{ s.full_name or ('Руководитель #' ~ s.user_id) }}</a></strong>
                {% if s.username %}<div class="muted">{{ s.username }}</div>{% endif %}
                {% if s.position %}<div class="muted">{{ s.position }}</div>{% endif %}
                {% if s.capacity %}<div class="muted">Лимит: {{ s.capacity }}</div>{% endif %}
              </td>
              <td>{{ '%.2f'|format(s.score) if s.score is not none else '-' }}</td>
              <td>
                {% if topic.author_user_id %}
                  <details>
                    <summary>Пригласить</summary>
                    <form class="stacked-form" method="post" action="/send-request">
                      <input type="hidden" name="sender_user_id" value="{{ topic.author_user_id }}" />
                      <input type="hidden" name="receiver_user_id" value="{{ s.user_id }}" />
                      <input type="hidden" name="topic_id" value="{{ topic.id }}" />
                      <input type="hidden" name="return_url" value="{{ request.url.path }}#supervisor-candidates" />
                      <label>Сообщение<textarea class="form-control" name="body" required>{{ s.default_message }}</textarea></label>
                      <div class="form-actions"><button class="btn" type="submit">Отправить приглашение</button></div>
                    </form>
                  </details>
                {% else %}
                  <span class="muted">Нет автора темы для отправки заявки</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">Запустите подбор, чтобы получить рекомендации.</p>
    {% endif %}
  </article>
</section>
{% endblock %}
