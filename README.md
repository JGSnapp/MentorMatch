# MentorMatch

Платформа для подбора студентов и научных руководителей: FastAPI backend, веб‑админка, Telegram‑бот, импорт из Google Sheets и ранжирование кандидатов (LLM с фолбэком).

## Возможности

- Админка: импорт из Google Sheets, добавление научных руководителей/тем, списки последних записей, простой подбор.
- Telegram‑бот: просмотр списков, импорт из Sheets, подбор кандидатов по теме.
- Мэтчинг: топ‑5 кандидатов через LLM (через прокси), при <5 записях или ошибке LLM — корректный фолбэк.
- БД: PostgreSQL, готовая схема (`01_schema.sql`).

## Что нового

- Нормализация Telegram при импорте: если ник начинается с `@`, он удаляется; если ссылка не начинается с `https://t.me/`, приводится к полному виду `https://t.me/<username>` (и так сохраняется в поле `users.username`).
- Резюме (CV) студентов:
  - При импорте URL резюме скачивается на сервер и сохраняется в локальное хранилище (`/media/{id}`) с записью в таблицу `media_files`.
  - В профиле студента CV отображается кликабельной ссылкой на локальный файл (`/media/{id}`).
  - Текст CV автоматически извлекается (pdf/docx/txt, best‑effort) и добавляется в входные данные для LLM при ранжировании (как часть профиля студента).
- Темы руководителей: добавлено поле `direction` (направление: 9/11/45). При импорте из таблицы, если темы указаны раздельно по направлениям, каждая тема получает соответствующее значение `direction`.
- Роли: добавлена сущность `roles` на тему. Можно добавлять роли через админку (в карточке темы), просматривать и подбирать студентов под конкретную роль. Матчинг студент→роль и роль→студенты сохраняется в `student_candidates` и `role_candidates` соответственно. Подбор тем для руководителей сохраняется в `supervisor_candidates`. Таблица `topic_candidates` теперь используется только для кандидатов‑руководителей под тему.
- Экспорт пар в Google Sheets: переменная `PAIRS_SPREADSHEET_ID` указывает таблицу, куда выгружается список строк «Тема, Роль, Студент, Руководитель». В админке добавлена кнопка «Выгрузить пары…». Экспорт также запускается автоматически при добавлении роли и при подтверждении заявок.

## Развёртывание (Docker)

1) Подготовьте окружение:
   - Скопируйте файл окружения: `cp env.example .env`
   - Заполните переменные в `.env`:
     - `TELEGRAM_BOT_TOKEN` — токен бота
     - `SPREADSHEET_ID` — ID таблицы Google Sheets
     - `SERVICE_ACCOUNT_FILE=service-account.json` — путь к JSON сервисного аккаунта внутри контейнера сервера. По умолчанию положите файл в `server/service-account.json` (смонтируется как `/app/service-account.json`).
    - `PROXY_API_KEY` и `PROXY_BASE_URL` — для LLM‑ранжирования; без них будет фолбэк на простой топ‑N.
    - `PAIRS_SPREADSHEET_ID` — (опционально) ID таблицы Google Sheets для выгрузки пар «Тема–Роль–Студент–Руководитель».

2) Запуск:
```bash
docker-compose up -d --build
```

3) Доступ:
- Админка/API: `http://localhost:8000`
- Swagger: `http://localhost:8000/docs`
- pgAdmin: `http://localhost:8080` (логин/пароль из `.env`), добавьте сервер вручную: host `postgres`, port `5432`, db `mentormatch`, user `mentormatch`, password `secret`.

4) Импорт из Google Sheets:
- В админке на главной странице заполните форму «Обновить данные из Google Sheets» (Spreadsheet ID подставится из `.env`).
- Либо через Telegram‑бота кнопкой «Импорт из Google Sheets».

API для импорта:
- Студенты: POST `/api/import-sheet` с `spreadsheet_id` и опционально `sheet_name` (по умолчанию первый лист).
- Руководители: POST `/api/import-supervisors` с `spreadsheet_id` и опционально `sheet_name` (по умолчанию второй лист той же таблицы). Во время импорта поле «Темы или тематики для ВКР» разбирается LLM и полученные темы автоматически добавляются в БД за авторством руководителя (роль `supervisor`, `seeking_role='student'`). При отсутствии LLM — используется простая эвристика (разделители `;`/переводы строк).

Примечания:
- Схема БД применяется автоматически из `01_schema.sql` при первом старте PostgreSQL.
- Если видите предупреждение о `python-multipart`, пересоберите контейнер сервера (`--build`) — зависимость уже указана в `server/requirements.txt`.
- Дедупликация студентов при импорте идёт по email (без учёта регистра), при отсутствии email — по ФИО.

## Структура

```
MentorMatch/
├── server/
│   ├── main.py            # API (JSON), интеграции и матчинг
│   ├── admin.py           # Маршруты веб‑админки (HTML)
│   ├── matching.py        # Логика подбора (LLM + фолбэк)
│   ├── parse_gform.py     # Парсер Google Sheets
│   └── requirements.txt   # Зависимости сервера
├── bot/
│   ├── bot.py             # Логика бота
│   ├── run_bot.py         # Точка входа
│   └── requirements.txt   # Зависимости бота
├── templates/              # HTML шаблоны админки
├── 01_schema.sql          # SQL‑схема Postgres (автоинициализация)
├── schema.md              # Описание схемы
├── docker-compose.yml     # Оркестрация (server, bot, postgres, pgadmin)
├── env.example            # Пример .env
└── README.md
```

## Полезное
- Сброс данных БД: `docker compose down -v` (удалит том с данными Postgres).
- Если образы не тянутся с Docker Hub (таймауты) — перезапустите Docker Desktop/WSL, выполните `docker login`, или потяните образы вручную (`docker pull postgres:16`, `docker pull dpage/pgadmin4`).
